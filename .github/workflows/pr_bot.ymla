name: Security Scans and Bot Check

on:
  pull_request:  # Trigger workflow for PRs (more secure for external contributions)
    types: [opened, reopened, synchronize, edited]

permissions:
  actions: read
  issues: write
  pull-requests: write
  contents: read

jobs:
  Snyk_scanning:
    name: Snyk Bot scan 
    runs-on: ubuntu-latest
    continue-on-error: true  
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Remove Node Modules and Lock File
        run: |
          echo "Removing node_modules and package-lock.json..."
          rm -rf node_modules
          rm -f package-lock.json

      - name: Install Dependencies
        run: |
          echo "Running npm install..."
          npm install

      - name: Download and Authenticate Snyk CLI
        run: |
          echo "Downloading and authenticating Snyk CLI..."
          curl -Lo ./snyk "https://github.com/snyk/snyk/releases/download/v1.1100.0/snyk-linux"
          chmod +x snyk
          ./snyk auth ${{ secrets.SNYK_TOKEN }}

      - name: Run Snyk Test and Monitor (Colorful Output)
        run: |
          echo "Running Snyk test and monitor..."
          ./snyk test --all-projects --color || true
          ./snyk monitor --all-projects || true

  TruffleHog_scanning:
    name: TruffleHog Bot scan
    runs-on: ubuntu-latest
    continue-on-error: true  
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Install TruffleHog
        run: |
          echo "Installing TruffleHog..."
          pip install truffleHog

      - name: Run TruffleHog Scan
        run: |
          echo "Running TruffleHog scan..."
          trufflehog --regex --json --entropy=False ${{ github.event.pull_request.head.repo.clone_url }}

  BotCheck:
    name: Bot scan 
    runs-on: ubuntu-latest
    needs: [Snyk_scanning, TruffleHog_scanning]
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install dependencies
        run: |
          npm ci

      - name: Run PR Scan Bot
        run: |
          node index.js
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
